name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions: {}

jobs:
  build:
    name: Build distributions
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7
        with:
          python-version: "3.14"
          enable-cache: true

      - name: Check tag matches project version
        run: |
          uv run --no-project python - <<'PY'
          import os
          import re
          import tomllib
          from pathlib import Path

          tag = os.environ.get('GITHUB_REF_NAME', '')
          tag_version = tag[1:] if tag.startswith('v') else tag

          pyproject = tomllib.loads(Path('pyproject.toml').read_text(encoding='utf-8'))
          project_version = pyproject['project']['version']

          init_version = None
          init_path = Path('src') / 'untether' / '__init__.py'
          if init_path.is_file():
            m = re.search(r'__version__\s*=\s*"([^"]+)"', init_path.read_text(encoding='utf-8'))
            if m:
              init_version = m.group(1)

          if project_version != tag_version:
            raise SystemExit(f"Tag {tag!r} does not match pyproject version {project_version!r}")
          if init_version and init_version != project_version:
            raise SystemExit(
              f"src/untether/__init__.py __version__ {init_version!r} does not match pyproject version {project_version!r}"
            )

          print(f"OK: tag {tag!r} matches version {project_version!r}")
          PY

      - name: Run tests
        run: uv run pytest

      - name: Build (wheel + sdist)
        run: uv build

      - name: Upload dist artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dist
          path: dist/
          if-no-files-found: error

  publish:
    name: Publish to PyPI (trusted publishing)
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/untether
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: dist
          path: dist/

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # release/v1
        with:
          packages-dir: dist/
          skip-existing: true

  github-release:
    name: Create GitHub Release
    needs: publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7
        with:
          python-version: "3.14"
          enable-cache: true

      - name: Download dist artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: dist
          path: dist/

      - name: Create GitHub release and upload artifacts
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          generate_release_notes: true
          files: |
            dist/*


